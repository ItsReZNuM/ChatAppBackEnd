<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8" />
    <title>Simple Group Chat</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            max-width: 700px;
            margin: 30px auto;
            background: #fafafa;
        }

        #login,
        #chat {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            background: white;
        }

        #chat {
            display: none;
        }

        #messages {
            border: 1px solid #ddd;
            height: 420px;
            overflow-y: auto;
            padding: 8px;
            margin-bottom: 8px;
            background: #fefefe;
        }

        .msg {
            margin: 6px 0;
            padding: 6px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #eee;
        }

        .mine {
            background: #eef6ff;
            border-color: #cfe9ff;
        }

        .meta {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .actions {
            margin-top: 4px;
            display: flex;
            gap: 6px;
        }

        .btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #aaa;
            background: #f7f7f7;
            cursor: pointer;
        }

        .btn:hover {
            background: #eee;
        }

        input,
        button {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #aaa;
        }

        button {
            cursor: pointer;
            background: #4caf50;
            color: white;
            border: none;
        }

        button:hover {
            background: #45a049;
        }

        .system {
            color: gray;
            font-style: italic;
            padding: 4px 0;
        }

        .edited-tag {
            font-size: 11px;
            color: #999;
        }

        #attachBtn {
            font-size: 20px;
            background: none;
            border: none;
            cursor: pointer;
            transition: 0.2s;
        }

        #attachBtn:hover {
            transform: scale(1.1);
        }

        .chat-img {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .chat-video {
            max-width: 300px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .reply-preview {
            font-size: 12px;
            color: #444;
            background: #f7f7f7;
            border-left: 3px solid #4caf50;
            padding: 4px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
        }
    </style>
</head>

<body>

    <div id="login">
        <h3>Ÿàÿ±ŸàÿØ ÿ®Ÿá ⁄Øÿ±ŸàŸá</h3>
        <input id="username" placeholder="€åŸàÿ≤ÿ±ŸÜ€åŸÖ" />
        <input id="room" type="number" placeholder="ÿ¢€åÿØ€å ⁄Øÿ±ŸàŸá (ÿπÿØÿØ)" />
        <button id="join">Ÿàÿ±ŸàÿØ</button>
        <p id="loginError" style="color:#d00"></p>
    </div>

    <div id="chat" style="display:none; flex-direction:column; height:100%;">
        <h3 id="roomTitle"></h3>

        <!-- ŸÖÿ≠ŸÑ ŸÜŸÖÿß€åÿ¥ Ÿæ€åÿßŸÖ‚ÄåŸáÿß -->
        <div id="messages" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
        <!-- ŸÜŸÖÿß€åÿ¥ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ±€åŸæŸÑÿß€å -->
        <div id="replyBox"
            style="display:none; background:#f0f0f0; border-left:4px solid #4caf50; padding:6px; border-radius:4px; margin-bottom:6px; font-size:13px;">
            <span id="replyInfo"></span>
            <button id="cancelReply"
                style="float:right; background:none; border:none; cursor:pointer; color:#d00;">‚ùå</button>
        </div>

        <!-- ŸÅ€åŸÑÿØ ÿßÿ±ÿ≥ÿßŸÑ Ÿæ€åÿßŸÖ + ÿØ⁄©ŸÖŸá ÿ≥ŸÜÿ¨ÿßŸÇ + ÿßÿ±ÿ≥ÿßŸÑ -->
        <div style="display:flex; gap:8px; align-items:center;">
            <input id="messageInput" placeholder="Ÿæ€åÿßŸÖ ÿ®ŸÜŸà€åÿ≥..." style="flex:1" />
            <input type="file" id="fileInput" hidden />
            <button id="attachBtn" type="button" title="ÿßÿ±ÿ≥ÿßŸÑ ŸÅÿß€åŸÑ">üìé</button>
            <button id="send" type="button">ÿßÿ±ÿ≥ÿßŸÑ</button>

        </div>
    </div>


    <script>
        const socket = io("http://localhost:8000", { transports: ["websocket"] });
        let username = null;
        let roomId = null;
        let replyingTo = null;

        const loginDiv = document.getElementById("login");
        const chatDiv = document.getElementById("chat");
        const messagesDiv = document.getElementById("messages");
        const sendBtn = document.getElementById("send");
        const messageInput = document.getElementById("messageInput");
        const loginError = document.getElementById("loginError");

        document.getElementById("join").onclick = () => {
            username = document.getElementById("username").value.trim();
            roomId = parseInt(document.getElementById("room").value);
            if (!username || !roomId) {
                alert("€åŸàÿ≤ÿ±ŸÜ€åŸÖ Ÿà ÿ¢€åÿØ€å ⁄Øÿ±ŸàŸá ÿßŸÑÿ≤ÿßŸÖ€å ÿßÿ≥ÿ™");
                return;
            }
            loginError.textContent = "";
            socket.emit("join", { username, room_id: roomId });
        };

        // ÿ™ÿßÿ®ÿπ ÿ™ÿ®ÿØ€åŸÑ ÿ™ÿßÿ±€åÿÆ ŸÖ€åŸÑÿßÿØ€å ÿ®Ÿá ÿ¨ŸÑÿßŸÑ€å
        function toJalaliHM(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            const j = jalaali.toJalaali(d);
            const pad = (n) => String(n).padStart(2, "0");
            return `${j.jy}/${pad(j.jm)}/${pad(j.jd)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        socket.on("error", (e) => {
            if (e?.message?.includes("€åŸàÿ≤ÿ±ŸÜ€åŸÖ")) {
                loginError.textContent = e.message;
            } else {
                console.error("ERR:", e);
            }
        });

        socket.on("history", (data) => {
            loginDiv.style.display = "none";
            chatDiv.style.display = "block";
            document.getElementById("roomTitle").textContent = `üí¨ ⁄Øÿ±ŸàŸá ÿ¥ŸÖÿßÿ±Ÿá ${data.room_id}`;
            messagesDiv.innerHTML = "";

            data.messages.forEach((m) => {
                const content = (m.reply_text)
                    ? { text: m.content, replied_to_user: m.reply_user, replied_to_text: m.reply_text }
                    : m.content;

                const mine = m.username?.trim()?.toLowerCase() === username?.trim()?.toLowerCase();
                appendMsg(m.id, m.username, content, mine, toJalaliHM(m.created_at), !!m.edited_at);
            });

            scrollToBottom();
        });


        socket.on("message", (m) => {
            const content = (m.reply_text)
                ? { text: m.content, replied_to_user: m.reply_user, replied_to_text: m.reply_text }
                : m.content;

            const mine = m.username.trim().toLowerCase() === username.trim().toLowerCase();
            if (mine) {
                const local = messagesDiv.querySelector(`[data-id^="local-"]`);
                if (local) local.remove();
            }

            appendMsg(m.id, m.username, content, mine, toJalaliHM(m.created_at), !!m.edited_at);
            scrollToBottom();
        });



        socket.on("message_edited", (m) => {
            updateMsgContent(m.id, m.username, m.content, true, toJalaliHM(m.edited_at));
        });

        socket.on("message_deleted", (m) => {
            console.log("üü¢ Ÿæ€åÿßŸÖ ÿ≠ÿ∞ŸÅ‚Äåÿ¥ÿØŸá ÿßÿ≤ ÿ≥ÿ±Ÿàÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ¥ÿØ:", m);
            removeMsg(m.id);
        });

        socket.on("system", (m) => appendSystem(m.message));
        socket.on("connect", () => console.log("connected"));

        sendBtn.onclick = sendMessage;
        messageInput.addEventListener("keyup", (e) => { if (e.key === "Enter") sendMessage(); });
        // --- üìé ÿßÿ±ÿ≥ÿßŸÑ ŸÅÿß€åŸÑ ---
        const fileInput = document.getElementById("fileInput");
        const attachBtn = document.getElementById("attachBtn");

        attachBtn.onclick = (e) => {
            e.preventDefault(); // ÿ¨ŸÑŸà⁄Ø€åÿ±€å ÿßÿ≤ ÿ±ŸÅÿ™ÿßÿ± Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ ŸÅÿ±ŸÖ
            fileInput.click();
        };

        fileInput.onchange = async () => {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch("http://127.0.0.1:8000/api/upload/", {
                    method: "POST",
                    body: formData,
                });
                console.log("üîπ Uploading to:", window.location.origin + "/api/upload/");
                const data = await res.json();
                const fileUrl = data.url;

                console.log("üìé ŸÅÿß€åŸÑ ÿ¢ŸæŸÑŸàÿØ ÿ¥ÿØ:", fileUrl);
                socket.emit("media_message", { username, room_id: roomId, file_url: fileUrl });
            } catch (err) {
                console.error("‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿ¢ŸæŸÑŸàÿØ ŸÅÿß€åŸÑ:", err);
            }

            fileInput.value = "";
        };

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            socket.emit("message", {
                room_id: roomId,
                username,
                content: text,
                replied_to: replyingTo,
            });

            appendMsg(
                "local-" + Date.now(),
                username,
                text,
                true,
                toJalaliHM(new Date().toISOString()),
                false
            );

            messageInput.value = "";
            replyingTo = null;
            document.getElementById("replyBox").style.display = "none";
            scrollToBottom();
        }


        // ====== ÿ≥ÿßÿÆÿ™ ŸÜŸÖÿß€åÿ¥ Ÿæ€åÿßŸÖ‚ÄåŸáÿß =======
        function appendMsg(id, user, text, mine = false, jtime = "", edited = false) {
            const div = document.createElement("div");
            div.classList.add("msg");
            div.dataset.id = id;

            user = user || "ŸÜÿßÿ¥ŸÜÿßÿ≥";

            // preview ÿ±€åŸæŸÑÿß€å (ŸÅŸÇÿ∑ ÿß⁄Øÿ± reply_* Ÿáÿ≥ÿ™)
            if (text && typeof text === "object" && text.replied_to_text) {
                const preview = document.createElement("div");
                preview.classList.add("reply-preview");
                preview.textContent = `ÿØÿ± Ÿæÿßÿ≥ÿÆ ÿ®Ÿá "${text.replied_to_text}" ÿßÿ≤ ÿ∑ÿ±ŸÅ ${text.replied_to_user}`;
                div.appendChild(preview);
            }

            // ÿ®ÿØŸÜŸá Ÿæ€åÿßŸÖ
            const body = document.createElement("div");
            body.classList.add("body");
            body.textContent = `${user}: ${typeof text === "object" ? text.text : text}`;
            div.appendChild(body);

            // ŸÖÿ™ÿß
            const meta = document.createElement("div");
            meta.classList.add("meta");
            meta.innerHTML = `<span>${jtime}</span>${edited ? '<span class="edited-tag">edited</span>' : ""}`;
            div.appendChild(meta);

            // ÿß⁄©ÿ¥ŸÜ‚ÄåŸáÿß
            const actions = document.createElement("div");
            actions.classList.add("actions");

            // ÿ±€åŸæŸÑÿß€å ÿ®ÿ±ÿß€å ŸáŸÖŸá
            const replyBtn = document.createElement("button");
            replyBtn.classList.add("btn");
            replyBtn.textContent = "ÿ±€åŸæŸÑÿß€å";
            replyBtn.onclick = () => startReply(id, user, (typeof text === "object" ? text.text : text));
            actions.appendChild(replyBtn);

            // ÿßÿØ€åÿ™/ÿ≠ÿ∞ŸÅ ŸÅŸÇÿ∑ ÿ®ÿ±ÿß€å ÿÆŸàÿØŸÖ
            const isMine = user?.trim()?.toLowerCase() === username?.trim()?.toLowerCase();
            if (isMine && !String(id).startsWith("local-")) {
                const editBtn = document.createElement("button");
                editBtn.classList.add("btn");
                editBtn.textContent = "Ÿà€åÿ±ÿß€åÿ¥";
                editBtn.onclick = () => {
                    const cur = (typeof text === "object" ? text.text : text);
                    const newText = prompt("ŸÖÿ™ŸÜ ÿ¨ÿØ€åÿØ Ÿæ€åÿßŸÖ:", cur);
                    if (!newText || newText.trim() === cur) return;
                    socket.emit("edit_message", { message_id: id, username, content: newText.trim() });
                };
                actions.appendChild(editBtn);

                const delBtn = document.createElement("button");
                delBtn.classList.add("btn");
                delBtn.textContent = "ÿ≠ÿ∞ŸÅ";
                delBtn.onclick = () => {
                    if (!confirm("ÿ≠ÿ∞ŸÅ ÿ¥ŸàÿØÿü")) return;
                    socket.emit("delete_message", { message_id: id, username });
                };
                actions.appendChild(delBtn);
            }

            div.appendChild(actions);

            if (isMine) div.classList.add("mine");
            messagesDiv.appendChild(div);
        }


        // ====== ŸÖÿ™ÿØŸáÿß€å ⁄©ŸÖ⁄©€å =======
        function updateMsgContent(id, user, newText, edited, jtime) {
            const el = messagesDiv.querySelector(`[data-id="${id}"]`);
            if (!el) return;

            // ŸÅŸÇÿ∑ ÿ®ÿØŸÜŸá Ÿæ€åÿßŸÖ ÿ±ÿß ÿ™ÿ∫€å€åÿ± ÿ®ÿØŸáÿå ÿ®Ÿá preview ÿØÿ≥ÿ™ ŸÜÿ≤ŸÜ
            const body = el.querySelector(".body");
            if (body) body.textContent = `${user}: ${newText}`;

            // ŸÖÿ™ÿß€å Ÿæÿß€å€åŸÜ ÿ±ÿß ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ⁄©ŸÜ
            const meta = el.querySelector(".meta");
            if (meta) {
                meta.innerHTML = `<span>${jtime}</span>${edited ? '<span class="edited-tag">edited</span>' : ""}`;
            }

            // ŸÖÿßŸÑ⁄© Ÿæ€åÿßŸÖ
            const isMine = user?.trim()?.toLowerCase() === username?.trim()?.toLowerCase();
            el.classList.toggle("mine", isMine);

            // ÿß⁄Øÿ± ÿØ⁄©ŸÖŸá‚ÄåŸáÿß ŸÜÿ®ŸàÿØÿå ÿ®ÿ≥ÿßÿ≤
            if (isMine && !el.querySelector(".actions") && !String(id).startsWith("local-")) {
                const actions = document.createElement("div");
                actions.classList.add("actions");

                const editBtn = document.createElement("button");
                editBtn.classList.add("btn");
                editBtn.textContent = "Ÿà€åÿ±ÿß€åÿ¥";
                editBtn.onclick = () => {
                    const newTextPrompt = prompt("ŸÖÿ™ŸÜ ÿ¨ÿØ€åÿØ Ÿæ€åÿßŸÖ:", newText);
                    if (!newTextPrompt || newTextPrompt.trim() === newText) return;
                    socket.emit("edit_message", { message_id: id, username, content: newTextPrompt.trim() });
                };

                const delBtn = document.createElement("button");
                delBtn.classList.add("btn");
                delBtn.textContent = "ÿ≠ÿ∞ŸÅ";
                delBtn.onclick = () => {
                    if (!confirm("ÿ≠ÿ∞ŸÅ ÿ¥ŸàÿØÿü")) return;
                    socket.emit("delete_message", { message_id: id, username });
                };

                actions.appendChild(editBtn);
                actions.appendChild(delBtn);
                el.appendChild(actions);
            }
        }



        function removeMsg(id) {
            const el = messagesDiv.querySelector(`[data-id="${id}"]`);
            if (el) el.remove();
        }
        function startReply(id, user, text) {
            replyingTo = id;
            const replyBox = document.getElementById("replyBox");
            const replyInfo = document.getElementById("replyInfo");
            replyInfo.textContent = `ÿØÿ± Ÿæÿßÿ≥ÿÆ ÿ®Ÿá "${text}" ÿßÿ≤ ÿ∑ÿ±ŸÅ ${user}`;
            replyBox.style.display = "block";
        }

        document.getElementById("cancelReply").onclick = () => {
            replyingTo = null;
            document.getElementById("replyBox").style.display = "none";
        };

        function appendSystem(text) {
            const div = document.createElement("div");
            div.classList.add("system");
            div.textContent = text;
            messagesDiv.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        socket.on("media_message", (m) => {
            appendMediaMsg(m.username, m.file_url);
        });

        function appendMediaMsg(user, url) {
            const div = document.createElement("div");
            div.classList.add("msg");

            const ext = url.split(".").pop().toLowerCase();
            let content;

            if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                content = `<img src="${url}" class="chat-img" />`;
            } else if (["mp4", "webm"].includes(ext)) {
                content = `<video src="${url}" class="chat-video" controls></video>`;
            } else {
                content = `<a href="${url}" target="_blank">üìé ÿØÿßŸÜŸÑŸàÿØ ŸÅÿß€åŸÑ (${ext})</a>`;
            }

            div.innerHTML = `<b>${user}:</b><br>${content}`;
            document.getElementById("messages").appendChild(div);
            document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
        }

    </script>

</body>

</html>