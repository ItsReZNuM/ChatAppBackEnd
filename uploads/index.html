<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8" />
    <title>Simple Group Chat</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            max-width: 700px;
            margin: 30px auto;
            background: #fafafa;
        }

        #login,
        #chat {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            background: white;
        }

        #chat {
            display: none;
        }

        #messages {
            border: 1px solid #ddd;
            height: 420px;
            overflow-y: auto;
            padding: 8px;
            margin-bottom: 8px;
            background: #fefefe;
        }

        .msg {
            margin: 6px 0;
            padding: 6px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #eee;
        }

        .mine {
            background: #eef6ff;
            border-color: #cfe9ff;
        }

        .meta {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .actions {
            margin-top: 4px;
            display: flex;
            gap: 6px;
        }

        .btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #aaa;
            background: #f7f7f7;
            cursor: pointer;
        }

        .btn:hover {
            background: #eee;
        }

        input,
        button {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #aaa;
        }

        button {
            cursor: pointer;
            background: #4caf50;
            color: white;
            border: none;
        }

        button:hover {
            background: #45a049;
        }

        .system {
            color: gray;
            font-style: italic;
            padding: 4px 0;
        }

        .edited-tag {
            font-size: 11px;
            color: #999;
        }

        #attachBtn {
            font-size: 20px;
            background: none;
            border: none;
            cursor: pointer;
            transition: 0.2s;
        }

        #attachBtn:hover {
            transform: scale(1.1);
        }

        .chat-img {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .chat-video {
            max-width: 300px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .reply-preview {
            font-size: 12px;
            color: #444;
            background: #f7f7f7;
            border-left: 3px solid #4caf50;
            padding: 4px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
        }
    </style>
</head>

<body>

    <div id="login">
        <h3>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡</h3>
        <input id="username" placeholder="ÛŒÙˆØ²Ø±Ù†ÛŒÙ…" />
        <input id="room" type="number" placeholder="Ø¢ÛŒØ¯ÛŒ Ú¯Ø±ÙˆÙ‡ (Ø¹Ø¯Ø¯)" />
        <button id="join">ÙˆØ±ÙˆØ¯</button>
        <p id="loginError" style="color:#d00"></p>
    </div>

    <div id="chat" style="display:none; flex-direction:column; height:100%;">
        <h3 id="roomTitle"></h3>

        <!-- Ù…Ø­Ù„ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
        <div id="messages" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
        <!-- Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±ÛŒÙ¾Ù„Ø§ÛŒ -->
        <div id="replyBox"
            style="display:none; background:#f0f0f0; border-left:4px solid #4caf50; padding:6px; border-radius:4px; margin-bottom:6px; font-size:13px;">
            <span id="replyInfo"></span>
            <button id="cancelReply"
                style="float:right; background:none; border:none; cursor:pointer; color:#d00;">âŒ</button>
        </div>

        <!-- ÙÛŒÙ„Ø¯ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… + Ø¯Ú©Ù…Ù‡ Ø³Ù†Ø¬Ø§Ù‚ + Ø§Ø±Ø³Ø§Ù„ -->
        <div style="display:flex; gap:8px; align-items:center;">
            <input id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³..." style="flex:1" />
            <input type="file" id="fileInput" hidden />
            <button id="attachBtn" type="button" title="Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„">ğŸ“</button>
            <button id="send" type="button">Ø§Ø±Ø³Ø§Ù„</button>

        </div>
    </div>


    <script>
        const socket = io("http://localhost:8000", { transports: ["websocket"] });
        let username = null;
        let roomId = null;
        let replyingTo = null;

        const loginDiv = document.getElementById("login");
        const chatDiv = document.getElementById("chat");
        const messagesDiv = document.getElementById("messages");
        const sendBtn = document.getElementById("send");
        const messageInput = document.getElementById("messageInput");
        const loginError = document.getElementById("loginError");

        document.getElementById("join").onclick = () => {
            username = document.getElementById("username").value.trim();
            roomId = parseInt(document.getElementById("room").value);
            if (!username || !roomId) {
                alert("ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ùˆ Ø¢ÛŒØ¯ÛŒ Ú¯Ø±ÙˆÙ‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
                return;
            }
            loginError.textContent = "";
            socket.emit("join", { username, room_id: roomId });
        };

        // ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø¬Ù„Ø§Ù„ÛŒ
        function toJalaliHM(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            const j = jalaali.toJalaali(d);
            const pad = (n) => String(n).padStart(2, "0");
            return `${j.jy}/${pad(j.jm)}/${pad(j.jd)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        socket.on("error", (e) => {
            if (e?.message?.includes("ÛŒÙˆØ²Ø±Ù†ÛŒÙ…")) {
                loginError.textContent = e.message;
            } else {
                console.error("ERR:", e);
            }
        });

        socket.on("history", (data) => {
            loginDiv.style.display = "none";
            chatDiv.style.display = "block";
            document.getElementById("roomTitle").textContent = `ğŸ’¬ Ú¯Ø±ÙˆÙ‡ Ø´Ù…Ø§Ø±Ù‡ ${data.room_id}`;
            messagesDiv.innerHTML = "";

            data.messages.forEach((m) => {
                const content = (m.reply_text)
                    ? { text: m.content, replied_to_user: m.reply_user, replied_to_text: m.reply_text }
                    : m.content;

                const mine = m.username?.trim()?.toLowerCase() === username?.trim()?.toLowerCase();
                appendMsg(m.id, m.username, content, mine, toJalaliHM(m.created_at), !!m.edited_at);
            });

            scrollToBottom();
        });


        socket.on("message", (m) => {
            const content = (m.reply_text)
                ? { text: m.content, replied_to_user: m.reply_user, replied_to_text: m.reply_text }
                : m.content;

            const mine = m.username.trim().toLowerCase() === username.trim().toLowerCase();
            if (mine) {
                const local = messagesDiv.querySelector(`[data-id^="local-"]`);
                if (local) local.remove();
            }

            appendMsg(m.id, m.username, content, mine, toJalaliHM(m.created_at), !!m.edited_at);
            scrollToBottom();
        });



        socket.on("message_edited", (m) => {
            updateMsgContent(m.id, m.username, m.content, true, toJalaliHM(m.edited_at));
        });

        socket.on("message_deleted", (m) => {
            console.log("ğŸŸ¢ Ù¾ÛŒØ§Ù… Ø­Ø°Ùâ€ŒØ´Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:", m);
            removeMsg(m.id);
        });

        socket.on("system", (m) => appendSystem(m.message));
        socket.on("connect", () => console.log("connected"));

        sendBtn.onclick = sendMessage;
        messageInput.addEventListener("keyup", (e) => { if (e.key === "Enter") sendMessage(); });
        // --- ğŸ“ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ ---
        const fileInput = document.getElementById("fileInput");
        const attachBtn = document.getElementById("attachBtn");

        attachBtn.onclick = (e) => {
            e.preventDefault(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±ÙØªØ§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙØ±Ù…
            fileInput.click();
        };

        fileInput.onchange = async () => {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch("http://127.0.0.1:8000/api/upload/", {
                    method: "POST",
                    body: formData,
                });
                console.log("ğŸ”¹ Uploading to:", window.location.origin + "/api/upload/");
                const data = await res.json();
                const fileUrl = data.url;

                console.log("ğŸ“ ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯:", fileUrl);
                socket.emit("media_message", { username, room_id: roomId, file_url: fileUrl });
            } catch (err) {
                console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„:", err);
            }

            fileInput.value = "";
        };

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            socket.emit("message", {
                room_id: roomId,
                username,
                content: text,
                replied_to: replyingTo,
            });

            appendMsg(
                "local-" + Date.now(),
                username,
                text,
                true,
                toJalaliHM(new Date().toISOString()),
                false
            );

            messageInput.value = "";
            replyingTo = null;
            document.getElementById("replyBox").style.display = "none";
            scrollToBottom();
        }


        // ====== Ø³Ø§Ø®Øª Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ =======
        function appendMsg(id, user, text, mine = false, jtime = "", edited = false) {
            const div = document.createElement("div");
            div.classList.add("msg");
            div.dataset.id = id;

            user = user || "Ù†Ø§Ø´Ù†Ø§Ø³";

            // preview Ø±ÛŒÙ¾Ù„Ø§ÛŒ (ÙÙ‚Ø· Ø§Ú¯Ø± reply_* Ù‡Ø³Øª)
            if (text && typeof text === "object" && text.replied_to_text) {
                const preview = document.createElement("div");
                preview.classList.add("reply-preview");
                preview.textContent = `Ø¯Ø± Ù¾Ø§Ø³Ø® Ø¨Ù‡ "${text.replied_to_text}" Ø§Ø² Ø·Ø±Ù ${text.replied_to_user}`;
                div.appendChild(preview);
            }

            // Ø¨Ø¯Ù†Ù‡ Ù¾ÛŒØ§Ù…
            const body = document.createElement("div");
            body.classList.add("body");
            body.textContent = `${user}: ${typeof text === "object" ? text.text : text}`;
            div.appendChild(body);

            // Ù…ØªØ§
            const meta = document.createElement("div");
            meta.classList.add("meta");
            meta.innerHTML = `<span>${jtime}</span>${edited ? '<span class="edited-tag">edited</span>' : ""}`;
            div.appendChild(meta);

            // Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§
            const actions = document.createElement("div");
            actions.classList.add("actions");

            // Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡
            const replyBtn = document.createElement("button");
            replyBtn.classList.add("btn");
            replyBtn.textContent = "Ø±ÛŒÙ¾Ù„Ø§ÛŒ";
            replyBtn.onclick = () => startReply(id, user, (typeof text === "object" ? text.text : text));
            actions.appendChild(replyBtn);

            // Ø§Ø¯ÛŒØª/Ø­Ø°Ù ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ù…
            const isMine = user?.trim()?.toLowerCase() === username?.trim()?.toLowerCase();
            if (isMine && !String(id).startsWith("local-")) {
                const editBtn = document.createElement("button");
                editBtn.classList.add("btn");
                editBtn.textContent = "ÙˆÛŒØ±Ø§ÛŒØ´";
                editBtn.onclick = () => {
                    const cur = (typeof text === "object" ? text.text : text);
                    const newText = prompt("Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ§Ù…:", cur);
                    if (!newText || newText.trim() === cur) return;
                    socket.emit("edit_message", { message_id: id, username, content: newText.trim() });
                };
                actions.appendChild(editBtn);

                const delBtn = document.createElement("button");
                delBtn.classList.add("btn");
                delBtn.textContent = "Ø­Ø°Ù";
                delBtn.onclick = () => {
                    if (!confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
                    socket.emit("delete_message", { message_id: id, username });
                };
                actions.appendChild(delBtn);
            }

            div.appendChild(actions);

            if (isMine) div.classList.add("mine");
            messagesDiv.appendChild(div);
        }


        // ====== Ù…ØªØ¯Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ =======
        function updateMsgContent(id, user, newText, edited, jtime) {
            const el = messagesDiv.querySelector(`[data-id="${id}"]`);
            if (!el) return;

            // ÙÙ‚Ø· Ø¨Ø¯Ù†Ù‡ Ù¾ÛŒØ§Ù… Ø±Ø§ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡ØŒ Ø¨Ù‡ preview Ø¯Ø³Øª Ù†Ø²Ù†
            const body = el.querySelector(".body");
            if (body) body.textContent = `${user}: ${newText}`;

            // Ù…ØªØ§ÛŒ Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
            const meta = el.querySelector(".meta");
            if (meta) {
                meta.innerHTML = `<span>${jtime}</span>${edited ? '<span class="edited-tag">edited</span>' : ""}`;
            }

            // Ù…Ø§Ù„Ú© Ù¾ÛŒØ§Ù…
            const isMine = user?.trim()?.toLowerCase() === username?.trim()?.toLowerCase();
            el.classList.toggle("mine", isMine);

            // Ø§Ú¯Ø± Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ù†Ø¨ÙˆØ¯ØŒ Ø¨Ø³Ø§Ø²
            if (isMine && !el.querySelector(".actions") && !String(id).startsWith("local-")) {
                const actions = document.createElement("div");
                actions.classList.add("actions");

                const editBtn = document.createElement("button");
                editBtn.classList.add("btn");
                editBtn.textContent = "ÙˆÛŒØ±Ø§ÛŒØ´";
                editBtn.onclick = () => {
                    const newTextPrompt = prompt("Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ§Ù…:", newText);
                    if (!newTextPrompt || newTextPrompt.trim() === newText) return;
                    socket.emit("edit_message", { message_id: id, username, content: newTextPrompt.trim() });
                };

                const delBtn = document.createElement("button");
                delBtn.classList.add("btn");
                delBtn.textContent = "Ø­Ø°Ù";
                delBtn.onclick = () => {
                    if (!confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
                    socket.emit("delete_message", { message_id: id, username });
                };

                actions.appendChild(editBtn);
                actions.appendChild(delBtn);
                el.appendChild(actions);
            }
        }



        function removeMsg(id) {
            const el = messagesDiv.querySelector(`[data-id="${id}"]`);
            if (el) el.remove();
        }
        function startReply(id, user, text) {
            replyingTo = id;
            const replyBox = document.getElementById("replyBox");
            const replyInfo = document.getElementById("replyInfo");
            replyInfo.textContent = `Ø¯Ø± Ù¾Ø§Ø³Ø® Ø¨Ù‡ "${text}" Ø§Ø² Ø·Ø±Ù ${user}`;
            replyBox.style.display = "block";
        }

        document.getElementById("cancelReply").onclick = () => {
            replyingTo = null;
            document.getElementById("replyBox").style.display = "none";
        };

        function appendSystem(text) {
            const div = document.createElement("div");
            div.classList.add("system");
            div.textContent = text;
            messagesDiv.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        socket.on("media_message", (m) => {
            appendMediaMsg(m.username, m.file_url);
        });

        function appendMediaMsg(user, url) {
            const div = document.createElement("div");
            div.classList.add("msg");

            const ext = url.split(".").pop().toLowerCase();
            let content;

            if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                content = `<img src="${url}" class="chat-img" />`;
            } else if (["mp4", "webm"].includes(ext)) {
                content = `<video src="${url}" class="chat-video" controls></video>`;
            } else {
                content = `<a href="${url}" target="_blank">ğŸ“ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ (${ext})</a>`;
            }

            div.innerHTML = `<b>${user}:</b><br>${content}`;
            document.getElementById("messages").appendChild(div);
            document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
        }

    </script>

</body>

</html>